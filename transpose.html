<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Transpose</title>
		<style>
			body {
				margin: 0;
				text-align: center;
			}

			* {
				font-family: Calibri, Arial, sans-serif;
				box-sizing: border-box;
			}

			textarea {
				height: 500px;
				width: 100vw;
				max-width: 700px;
				font-family: monospace;
				font-size: 1.5em;
				resize: vertical;
				white-space: pre;
			}

			button {
				width: 100vw;
				max-width: 700px;
			}

			.fs15 {
				font-size: 1.5em;
			}

			.w50 {
				width: 50vw;
				max-width: 350px;
			}
		</style>

	</head>
	<body>
		<textarea id="ta"></textarea>
		<br><button type="button" onclick="transposeTo(this.innerHTML);" id="num" class="fs15">0</button>
		<br><button type="button" onclick="transpose(true);" class="w50 fs15">↑</button><button type="button" onclick="transpose(false);" class="w50 fs15">↓</button>
		<br><button type="button" onclick="transpose(false, true);">uvést tvar akordů do normálu, zobrazit diagramy</button>
		<br><button type="button" onclick="enConversion(true);" class="w50">vstup – převést B na H (z anglosaské notace)</button><button type="button" onclick="enConversion(false);" class="w50">výstup – převést H na B (do anglosaské notace)</button>
		<div id="chords"></div>
		<script src="chord.js"></script>
		<script>
			var ta = document.getElementById("ta");
			ta.value =
				"None Like You\n\nF          Csus4        Dm\nThere is none like you\nBb        F                C7\nNo one else can touch my heart like you do\nF      C         Dm        Bb\nI can search for all eternity long\n   Dmin        C       Bb    Fmaj\nAnd find there is none like you";
			var num = document.getElementById("num");
			var arrFlat = ["Cb", "Db", "Eb", "Fb", "Gb", "Ab", "Hb", "Ax", "Hx", "Ex"];
			var arrSharp = ["H", "Cx", "Dx", "E", "Fx", "Gx", "Bb", "Bb", "C", "F"];
			var arrFrom = ["Cx", "C", "Dx", "D", "E", "Fx", "F", "Gx", "G", "A", "Bb", "H"];
			var arrTo = ["P", "O", "R", "Q", "S", "U", "T", "W", "V", "X", "Y", "Z"];
			var arrUp = ["D", "Cx", "E", "Dx", "F", "G", "Fx", "A", "Gx", "Bb", "H", "C"];
			var arrDown = ["C", "H", "D", "Cx", "Dx", "F", "E", "G", "Fx", "Gx", "A", "Bb"];
			//var hint	=	["1",	"0",	"3",	"2",	"4",	"6",	"5",	"8",	"7",	"9",	"10",	"11"];
			function transpose(upY, tr = false) {
				if (upY) {
					num.innerHTML = (num.innerHTML) - (-1);
					if (num.innerHTML == 12) {
						num.innerHTML = 0;
					}
				} else if (tr) {
					num.innerHTML = num.innerHTML;
				} else {
					num.innerHTML = (num.innerHTML) - 1;
					if (num.innerHTML == -12) {
						num.innerHTML = 0;
					}
				}
				var song = ta.value.split("\n");
				for (var j = 0; j < song.length; j++) {
					if (areChords(song[j])) {
						song[j] = song[j].replace(/#/g, "x");
						var chords = song[j].split(/\b/);
						var pristi = false;
						for (var k = 0; k < chords.length; k++) {
							if (chords[k].replace(/\s+/, "") == "") {
								if (chords[k] == " " && k > 0) {
									chords[k] += " ";
								} else if (pristi) {
									chords[k] = chords[k].slice(1);
									pristi = false;
								}
							} else {
								var min = chords[k];
								chords[k] = chords[k].replace(/([ABCDEFGH])is/g, "$1#").replace(/([ABCDEFGH])es/g, "$1b");
								for (var i = 0; i < arrFlat.length; i++) {
									var regex = new RegExp(arrFlat[i], "g");
									chords[k] = chords[k].replace(regex, arrSharp[i]);
								}
								if (chords[k] == "B") {
									chords[k] = "Bb"
								}
								if (chords[k].replace(/[ABCDEFGH][#b]?mi/, "") == "") {
									chords[k] = chords[k].replace(/([ABCDEFGH][#b]?)mi/, "$1m");
								}
								if (chords[k].replace(/[ABCDEFGH][#b]?min/, "") == "") {
									chords[k] = chords[k].replace(/([ABCDEFGH][#b]?)min/, "$1m  ");
								}
								chords[k] = chords[k].replace(/([ABCDEFGH][#b]?)mi[^n]/, "$1m");
								chords[k] = chords[k].replace(/([ABCDEFGH][#b]?)-/g, "$1m");

								for (var i = 0; i < arrFrom.length; i++) {
									var regex = new RegExp(arrFrom[i], "g");
									chords[k] = chords[k].replace(regex, arrTo[i]);
								}
								for (var i = 0; i < arrFrom.length; i++) {
									var regex = new RegExp(arrTo[i], "g");
									if (upY) {
										chords[k] = chords[k].replace(regex, arrUp[i]);
									} else if (tr) {
										chords[k] = chords[k].replace(regex, arrFrom[i]);
									} else {
										chords[k] = chords[k].replace(regex, arrDown[i]);
									}
								}
								if (chords[k].length > min.length) {
									pristi = true;
								} else if (chords[k].length < min.length) {
									chords[k] += " ";
								}
							}
						}
						song[j] = chords.join("").replace(/x/g, "#");
					}
				}
				ta.value = song.join("\n");
			}

			function enConversion(fromEn) {
				var song = ta.value.split("\n");
				for (var j = 0; j < song.length; j++) {
					if (areChords(song[j])) {
						if (fromEn) {
							song[j] = song[j].replace("B", "H").replace("Hb", "Bb");
							transpose(false, true);
						} else {
							transpose(false, true);
							song[j] = song[j].replace("H", "B");
						}
					}
				}
				ta.value = song.join("\n");
			}

			function areChords(line) {
				var missing = ".,cefhkopqrvwxyzIJKLNOPQRSTUVWXYZ";
				var sum = 0;
				for (var i = 0; i < missing.length; i++) {
					sum += line.indexOf(missing[i]);
				}
				if (sum + missing.length == 0) {
					return true;
				} else {
					return false;
				}
			}

			function transposeTo(num) {
				if (num < 0) {
					while (num < 0) {
						transpose(true);
						num++;
					}
				} else if (num > 0) {
					while (num > 0) {
						transpose(false);
						num--;
					}
				}
			}
		</script>
	</body>
</html>